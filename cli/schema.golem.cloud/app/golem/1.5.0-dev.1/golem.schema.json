{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "https://schema.golem.cloud/app/golem/1.5.0-dev.1/golem.schema.json",
  "title": "Golem Application Manifest",
  "description": "Golem Application Manifest.",
  "type": "object",
  "properties": {
    "app": {
      "type": "string",
      "description": "Application name"
    },
    "includes": {
      "type": "array",
      "description": "Include paths or globs for searching for application manifest documents. Only allowed in root application manifest documents.",
      "items": {
        "type": "string"
      }
    },
    "tempDir": {
      "type": "string",
      "description": "Temporary directory used for generating and building WIT and WASM artifacts. Default location is golem-temp."
    },
    "witDeps": {
      "type": "array",
      "description": "List of source directories for common wit dependency packages",
      "items": {
        "type": "string"
      }
    },
    "componentTemplates": {
      "type": "object",
      "description": "Component templates by template names",
      "additionalProperties": {
        "$ref": "#/definitions/component"
      }
    },
    "components": {
      "type": "object",
      "description": "Components by component names",
      "additionalProperties": {
        "$ref": "#/definitions/component"
      }
    },
    "clean": {
      "type": "array",
      "description": "User defined extra paths used in the clean command.",
      "items": {
        "type": "string"
      }
    },
    "customCommands": {
      "type": "object",
      "description": "User defined custom commands.",
      "additionalProperties": {
        "type": "array",
        "items": {
          "$ref": "#/definitions/externalCommand"
        }
      }
    },
    "httpApi": {
      "type": "object",
      "description": "HTTP API definitions and deployments",
      "properties": {
        "definitions": {
          "type": "object",
          "description": "HTTP API definitions by name",
          "additionalProperties": {
            "$ref": "#/definitions/httpApiDefinition"
          }
        },
        "deployments": {
          "type": "object",
          "description": "HTTP API deployments by environments",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/httpApiDeployment"
            }
          }
        }
      }
    },
    "environments": {
      "type": "object",
      "description": "Application environments",
      "additionalProperties": {
        "properties": {
          "default": {
            "const": true,
            "description": "Use as default environment, only one can be selected, if missing, the first environment is used as default"
          },
          "account": {
            "type": "string",
            "description": "Optional account that owns the application environment. When not specified then th current user will be used."
          },
          "server": {
            "description": "Server for the environment, can be either  the built-in local or cloud servers, or a custom one. When not specified then the local server is used.",
            "oneOf": [
              {
                "const": "local"
              },
              {
                "const": "cloud"
              },
              {
                "type": "object",
                "properties": {
                  "url": {
                    "type": "string",
                    "description": "Custom URL for golem services"
                  },
                  "workerUrl": {
                    "type": "string",
                    "description": "Custom URL for golem worker service"
                  },
                  "allowInsecure": {
                    "type": "boolean",
                    "description": "Allow insecure connections to the server, defaults to false"
                  },
                  "auth": {
                    "oneOf": [
                      {
                        "type": "object",
                        "properties": {
                          "oauth2": {
                            "const": true
                          }
                        },
                        "required": [
                          "oauth2"
                        ]
                      },
                      {
                        "type": "object",
                        "properties": {
                          "staticToken": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "staticToken"
                        ]
                      }
                    ]
                  }
                },
                "required": [
                  "url",
                  "auth"
                ]
              }
            ]
          },
          "componentPresets": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            ]
          },
          "cli": {
            "type": "object",
            "properties": {
              "format": {
                "enum": [
                  "text",
                  "json",
                  "yaml",
                  "pretty",
                  "pretty-json",
                  "pretty-yaml"
                ],
                "description": "Default output format"
              },
              "autoConfirm": {
                "const": true,
                "description": "Enables auto-confirm (yes) flag by default"
              },
              "redeployAgents": {
                "const": true,
                "description": "Enables redeploy-agents flag by default"
              },
              "reset": {
                "const": true,
                "description": "Enables reset flag by default"
              }
            }
          },
          "deployment": {
            "type": "object",
            "properties": {
              "compatibilityCheck": {
                "type": "boolean"
              },
              "versionCheck": {
                "type": "boolean"
              },
              "securityOverrides": {
                "type": "boolean"
              }
            }
          }
        }
      }
    },
    "bridge": {
      "description": "Bridge SDK generator configuration",
      "type": "object",
      "properties": {
        "ts": {
          "description": "TypeScript SDK configuration",
          "$ref": "#/definitions/bridgeSdkLanguageTargets"
        },
        "rust": {
          "description": "Rust SDK configuration",
          "$ref": "#/definitions/bridgeSdkLanguageTargets"
        }
      }
    }
  },
  "definitions": {
    "component": {
      "description": "Component definition",
      "allOf": [
        {
          "$ref": "#/definitions/templates"
        },
        {
          "$ref": "#/definitions/componentProperties"
        },
        {
          "$ref": "#/definitions/componentPresets"
        }
      ]
    },
    "componentProperties": {
      "type": "object",
      "properties": {
        "sourceWit": {
          "type": "string",
          "description": "Source WIT directory for the user defined component WIT source(s)."
        },
        "generatedWit": {
          "type": "string",
          "description": "Generated WIT directory created by the golem tooling, which handles exported interface extraction and includes resolved package and stub dependencies."
        },
        "componentWasm": {
          "type": "string",
          "description": "File path for the built WASM component."
        },
        "linkedWasm": {
          "type": "string",
          "description": "File path for the linked WASM component which is ready to be uploaded to Golem."
        },
        "buildMergeMode": {
          "$ref": "#/definitions/vecMergeMode"
        },
        "build": {
          "type": "array",
          "description": "Commands used for creating component WASM.",
          "items": {
            "$ref": "#/definitions/buildCommand"
          }
        },
        "customCommands": {
          "type": "object",
          "description": "User defined custom commands.",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/externalCommand"
            }
          }
        },
        "clean": {
          "type": "array",
          "description": "User defined extra paths used in the clean command.",
          "items": {
            "type": "string"
          }
        },
        "componentType": {
          "enum": [
            "durable",
            "ephemeral",
            "library"
          ],
          "description": "Optional component type, defaults to durable."
        },
        "filesMergeMode": {
          "$ref": "#/definitions/vecMergeMode"
        },
        "files": {
          "type": "array",
          "description": "Initial component files system",
          "items": {
            "$ref": "#/definitions/initialComponentFile"
          }
        },
        "pluginsMergeMode": {
          "$ref": "#/definitions/vecMergeMode"
        },
        "plugins": {
          "type": "array",
          "description": "Installed plugins for the component",
          "items": {
            "$ref": "#/definitions/pluginInstallation"
          }
        },
        "envMergeMode": {
          "$ref": "#/definitions/mapMergeMode"
        },
        "env": {
          "type": "object",
          "description": "Environment variables for the component.",
          "additionalProperties": {
            "type": "string"
          }
        },
        "dependenciesMergeMode": {
          "$ref": "#/definitions/vecMergeMode"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/componentDependency"
          }
        }
      }
    },
    "componentPresets": {
      "type": "object",
      "description": "Component definition presets",
      "properties": {
        "presets": {
          "type": "object",
          "description": "Component definition presets",
          "additionalProperties": {
            "allOf": [
              {
                "type": "object",
                "additionalProperties": {
                  "default:": {
                    "const": true
                  }
                }
              },
              {
                "$ref": "#/definitions/componentProperties"
              }
            ]
          }
        }
      }
    },
    "templates": {
      "description": "List of parent component templates",
      "type": "object",
      "properties": {
        "templates": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        }
      }
    },
    "generateQuickJsCrateCommand": {
      "type": "object",
      "description": "Generate QuickJS Crate",
      "properties": {
        "generateQuickJsCrate": {
          "type": "string",
          "description": "QuickJS Crate path"
        },
        "wit": {
          "type": "string",
          "description": "WIT directory"
        },
        "jsModules": {
          "type": "object",
          "description": "JS module paths and modes",
          "additionalProperties": {
            "type": "string"
          }
        },
        "world": {
          "type": "object",
          "description": "Optional WIT world"
        }
      },
      "required": [
        "generateQuickJsCrate",
        "wit",
        "jsModules"
      ]
    },
    "generateQuickJsdtsCommand": {
      "type": "object",
      "description": "Generate QuickJS DTS",
      "properties": {
        "generateQuickJsdts": {
          "type": "string",
          "description": "QuickJS d.ts path"
        },
        "wit": {
          "type": "string",
          "description": "WIT directory"
        },
        "world": {
          "type": "object",
          "description": "Optional WIT world"
        }
      },
      "required": [
        "generateQuickJsdts",
        "wit",
        "jsModules"
      ]
    },
    "generateAgentWrapperCommand": {
      "type": "object",
      "description": "Generate Agent Wrapper",
      "properties": {
        "generateAgentWrapper": {
          "type": "string",
          "description": "Target path of the generated wrapper component"
        },
        "basedOnCompiledWasm": {
          "type": "string",
          "description": "Path of the compiled WASM component containing the dynamic golem:agent implementation"
        }
      },
      "required": [
        "generateAgentWrapper",
        "basedOnCompiledWasm"
      ]
    },
    "composeAgentWrapperCommand": {
      "type": "object",
      "description": "Compose Agent Wrapper",
      "properties": {
        "composeAgentWrapper": {
          "type": "string",
          "description": "Target path of the generated wrapper component"
        },
        "withAgent": {
          "type": "string",
          "description": "Path of the compiled WASM component implementing golem:agent"
        },
        "to": {
          "type": "string",
          "description": "Path of the resulting composed WASM component"
        }
      },
      "required": [
        "composeAgentWrapper",
        "withAgent",
        "to"
      ]
    },
    "injectToPrebuiltQuickjsCommand": {
      "type": "object",
      "description": "Inject to prebuilt QuickJS",
      "properties": {
        "injectToPrebuiltQuickjs": {
          "type": "string",
          "description": "Path to the prebuilt QuickJS WASM file that loads a JS module through a get-script import"
        },
        "module": {
          "type": "string",
          "description": "Path to the JS module"
        },
        "moduleWasm": {
          "type": "string",
          "description": "Path to the intermediate WASM containing the JS module"
        },
        "into": {
          "type": "string",
          "description": "Path to the output WASM component containing the injected JS module"
        }
      },
      "required": [
        "injectToPrebuiltQuickjs",
        "module",
        "moduleWasm",
        "into"
      ]
    },
    "buildCommand": {
      "oneOf": [
        {
          "$ref": "#/definitions/externalCommand"
        },
        {
          "$ref": "#/definitions/generateQuickJsCrateCommand"
        },
        {
          "$ref": "#/definitions/generateQuickJsdtsCommand"
        },
        {
          "$ref": "#/definitions/generateAgentWrapperCommand"
        },
        {
          "$ref": "#/definitions/composeAgentWrapperCommand"
        },
        {
          "$ref": "#/definitions/injectToPrebuiltQuickjsCommand"
        }
      ]
    },
    "externalCommand": {
      "type": "object",
      "description": "External command with optional inputs and outputs with up-to-date checks",
      "properties": {
        "command": {
          "type": "string",
          "description": "External command to execute"
        },
        "dir": {
          "type": "string",
          "description": "Working directory for the command, defaults to the directory of golem.yaml in which the component is defined."
        },
        "rmdirs": {
          "type": "array",
          "description": "List of directories that should be deleted before running the command, runs before mkdirs.",
          "items": {
            "type": "string"
          }
        },
        "mkdirs": {
          "type": "array",
          "description": "List of directories that should be created before running the command, runs after rmdirs",
          "items": {
            "type": "string"
          }
        },
        "sources": {
          "type": "array",
          "description": "Inputs (paths and globs) for the external command",
          "items": {
            "type": "string"
          }
        },
        "targets": {
          "type": "array",
          "description": "Output (paths and globs) for the external command",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "command"
      ],
      "if": {
        "required": [
          "sources"
        ]
      },
      "then": {
        "required": [
          "targets"
        ]
      }
    },
    "componentDependency": {
      "type": "object",
      "description": "Component dependencies",
      "oneOf": [
        {
          "properties": {
            "type": {
              "enum": [
                "wasm-rpc",
                "wasm",
                "wasm-rpc-static"
              ],
              "description": "Type of the dependency"
            },
            "target": {
              "type": "string",
              "description": "Target component name."
            }
          },
          "required": [
            "type",
            "target"
          ]
        },
        {
          "properties": {
            "type": {
              "enum": [
                "wasm"
              ],
              "description": "Type of the dependency"
            },
            "path": {
              "type": "string",
              "description": "Target component WASM path."
            }
          },
          "required": [
            "type",
            "path"
          ]
        },
        {
          "properties": {
            "type": {
              "enum": [
                "wasm"
              ],
              "description": "Type of the dependency"
            },
            "url": {
              "type": "string",
              "description": "Target component remote URL."
            }
          },
          "required": [
            "type",
            "url"
          ]
        }
      ]
    },
    "initialComponentFile": {
      "type": "object",
      "description": "File entry for the initial component file system.",
      "properties": {
        "sourcePath": {
          "type": "string",
          "description": "Source path for the component file: either a local file or an URL."
        },
        "targetPath": {
          "type": "string",
          "description": "Target path for the component file, must be an absolute path"
        },
        "permissions": {
          "enum": [
            "read-only",
            "read-write"
          ],
          "description": "Permission for the component file"
        }
      },
      "required": [
        "sourcePath",
        "targetPath"
      ]
    },
    "pluginInstallation": {
      "type": "object",
      "description": "Represents an installed plugin",
      "properties": {
        "account": {
          "type": "string",
          "description": "Account of the plugin"
        },
        "name": {
          "type": "string",
          "description": "Name of the plugin"
        },
        "version": {
          "type": "string",
          "description": "Version of the plugin"
        },
        "parameters": {
          "type": "object",
          "description": "Key-value pairs for configuring the plugin installation",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "required": [
        "name",
        "version"
      ]
    },
    "httpApiDefinition": {
      "type": "object",
      "description": "HTTP API Definition",
      "properties": {
        "version": {
          "type": "string",
          "description": "Version for the HTTP API definition"
        },
        "project": {
          "type": "string",
          "description": "Optional owner project of the HTTP API definition"
        },
        "routes": {
          "type": "array",
          "description": "Routes of the HTTP API definition",
          "items": {
            "$ref": "#/definitions/httpApiDefinitionRoute"
          }
        }
      },
      "required": [
        "version"
      ]
    },
    "httpApiDefinitionRoute": {
      "type": "object",
      "description": "HTTP API Definition Route",
      "properties": {
        "method": {
          "description": "HTTP method for the route",
          "enum": [
            "GET",
            "CONNECT",
            "POST",
            "DELETE",
            "PUT",
            "PATCH",
            "OPTIONS",
            "TRACE",
            "HEAD"
          ]
        },
        "path": {
          "description": "HTTP path pattern for the route",
          "type": "string"
        },
        "security": {
          "description": "Optional ID of the required HTTP API security",
          "type": "string"
        },
        "binding": {
          "description": "HTTP API Route Binding",
          "properties": {
            "type": {
              "description": "Binding type, default to simple worker binding",
              "enum": [
                "default",
                "cors-preflight",
                "file-server",
                "http-handler"
              ]
            },
            "componentName": {
              "type": "string",
              "description": "Component to be used in the binding"
            },
            "agent": {
              "type": "string",
              "description": "Rib script for calculating the agent to be used"
            },
            "idempotencyKey": {
              "type": "string",
              "description": "Rib script for calculating the idempotency key"
            },
            "invocationContext": {
              "type": "string",
              "description": "Rib script for calculating the invocation context"
            },
            "response": {
              "type": "string",
              "description": "Rib script for creating the response"
            }
          }
        }
      },
      "required": [
        "method",
        "path",
        "binding"
      ]
    },
    "httpApiDeployment": {
      "type": "object",
      "description": "HTTP API Deployment",
      "properties": {
        "domain": {
          "type": "string",
          "description": "Domain"
        },
        "definitions": {
          "type": "array",
          "description": "HTTP API definitions to be used in the deployment",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "domain"
      ]
    },
    "vecMergeMode": {
      "enum": [
        "append",
        "prepend",
        "replace"
      ]
    },
    "mapMergeMode": {
      "enum": [
        "upsert",
        "replace",
        "remove"
      ]
    },
    "bridgeSdkLanguageTargets": {
      "description": "Bridge SDK language targets",
      "type": "object",
      "properties": {
        "agents": {
          "description": "List of agent type names, component names or \"*\" for including all agents",
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          ]
        },
        "outputDir": {
          "description": "Custom output directory for the generated SDK",
          "type": "string"
        }
      },
      "required": [
        "agents"
      ]
    }
  }
}