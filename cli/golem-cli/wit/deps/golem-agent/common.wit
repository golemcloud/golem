package golem:agent@1.5.0;

interface common {
  use golem:core/types@1.5.0.{value-and-type, wit-type, wit-value, agent-id, account-id, component-id,
    text-type, text-reference, binary-type, binary-reference,
    text-descriptor, binary-descriptor, element-schema, element-value, data-schema, data-value};
  use wasi:clocks/monotonic-clock@0.2.3.{duration};

  enum agent-mode {
    durable,
    ephemeral
  }

  record agent-type {
    type-name:    string,
    description:  string,
    %constructor: agent-constructor,
    methods:      list<agent-method>,
    dependencies: list<agent-dependency>,
    mode:         agent-mode,
    http-mount:   option<http-mount-details>,
    snapshotting: snapshotting,
    config:       list<config-key-value-type>,
  }

  /// Associates an agent type with a component that implements it
  record registered-agent-type {
    agent-type: agent-type,
    implemented-by: component-id
  }

  record agent-dependency {
    type-name:    string,
    description:  option<string>,
    %constructor: agent-constructor,
    methods:      list<agent-method>,
  }

  record agent-method {
    name:          string,
    description:   string,
    http-endpoint: list<http-endpoint-details>,
    prompt-hint:   option<string>,
    input-schema:  data-schema,
    output-schema: data-schema,
  }

  record http-mount-details {
    path-prefix:    list<path-segment>,
    auth-details:   option<auth-details>,
    phantom-agent:  bool,
    cors-options:   cors-options,
    webhook-suffix: list<path-segment>,
  }

  record cors-options {
    allowed-patterns: list<string>,
  }

  record http-endpoint-details {
    http-method: http-method,
    path-suffix:  list<path-segment>,
    header-vars:  list<header-variable>,
    query-vars:   list<query-variable>,
    auth-details: option<auth-details>,
    cors-options: cors-options,
  }

  variant http-method {
    get,
    head,
    post,
    put,
    delete,
    connect,
    options,
    trace,
    patch,
    custom(string),
  }

  variant path-segment {
    literal(string),
    system-variable(system-variable),
    path-variable(path-variable),
    // only allowed as the last segment
    remaining-path-variable(path-variable)
  }

  enum system-variable {
    agent-type,
    agent-version
  }

  record path-variable {
    variable-name: string,
  }

  record header-variable {
    header-name: string,
    variable-name: string,
  }

  record query-variable {
    query-param-name: string,
    variable-name: string,
  }

  record auth-details {
    required: bool,
  }

  variant principal {
    oidc(oidc-principal),
    agent(agent-principal),
    golem-user(golem-user-principal),
    anonymous
  }

  record oidc-principal {
    sub:      string,
    issuer: string,

    email:    option<string>,
    name:     option<string>,
    email-verified: option<bool>,
    given-name:     option<string>,
    family-name:    option<string>,
    picture:        option<string>,
    preferred-username:       option<string>,

    claims: string,
  }

  record agent-principal {
    agent-id: agent-id,
  }

  record golem-user-principal {
    account-id: account-id
  }

  record agent-constructor {
    name:          option<string>,
    description:   string,
    prompt-hint:   option<string>,
    input-schema:  data-schema,
  }



  /// Agent-level failures
  variant agent-error {
    invalid-input(string),
    invalid-method(string),
    invalid-type(string),
    invalid-agent-id(string),
    custom-error(value-and-type),
  }

  variant snapshotting {
    disabled,
    enabled(snapshotting-config)
  }

  variant snapshotting-config {
    default, // current default in the server
    periodic(duration),
    every-n-invocation(u16)
  }

  record config-key-value-type {
    key:   list<string>,
    value: config-value-type,
  }

  variant config-value-type {
    local(wit-type),
    shared(wit-type),
  }
}
