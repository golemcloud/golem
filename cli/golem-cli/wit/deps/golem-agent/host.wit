package golem:agent@1.5.0;

interface host {
    use golem:core/types@1.5.0.{component-id, uuid, promise-id};
    use wasi:clocks/wall-clock@0.2.3.{datetime};
    use wasi:io/poll@0.2.3.{pollable};
    use common.{agent-error, agent-type, data-value, registered-agent-type};

    /// Gets all the registered agent types
    get-all-agent-types: func() -> list<registered-agent-type>;

    /// Get a specific registered agent type by name
    get-agent-type: func(agent-type-name: string) -> option<registered-agent-type>;

    /// Constructs a string agent-id from the agent type and its constructor parameters
    /// and an optional phantom ID
    make-agent-id: func(agent-type-name: string, input: data-value, phantom-id: option<uuid>) -> result<string, agent-error>;

    /// Parses an agent-id (created by `make-agent-id`) into an agent type name and its constructor parameters
    /// and an optional phantom ID
    parse-agent-id: func(agent-id: string) -> result<tuple<string, data-value, option<uuid>>, agent-error>;

    /// Creates a webhook that can be used to integrate with webhook driven apis.
    /// When the created url is called with a post request, the provided promise-id is completed with the body of the post request.
    /// Note the following behaviours:
    /// * Only agents whoose agent types are _currently_ deployed via an http api are allowed to create a webhook. Calling this function while the agent
    ///    is not deployed via an http api will trap.
    /// * Only the agent type that created the promise is allowed to create a webhook for it. Using this host function
    ///   from a different agent type will trap.
    create-webhook: func(promise-id: promise-id) -> string;

    /// Possible failures of an RPC call
    variant rpc-error {
      /// Protocol level error
      protocol-error(string),
      /// Access denied
      denied(string),
      /// Target agent or function not found
      not-found(string),
      /// Internal error on the remote side
      remote-internal-error(string),
      /// The remote endpoint returned an agent-domain error
      remote-agent-error(agent-error)
    }

    /// An RPC client for invoking remote agents
    resource wasm-rpc {
      /// Constructs the RPC client connecting to the given target agent
      constructor(agent-type-name: string, %constructor: data-value, phantom-id: option<uuid>);

      /// Invokes a remote method with the given parameters, and awaits the result
      invoke-and-await: func(method-name: string, input: data-value) -> result<data-value, rpc-error>;

      /// Triggers the invocation of a remote method with the given parameters, and returns immediately.
      invoke: func(method-name: string, input: data-value) -> result<_, rpc-error>;

      /// Invokes a remote method with the given parameters, and returns a `future-invoke-result` value which can
      /// be polled for the result.
      ///
      /// With this function it is possible to call multiple (different) agents simultaneously.
      async-invoke-and-await: func(method-name: string, input: data-value) -> future-invoke-result;

      /// Schedule invocation for later
      schedule-invocation: func(scheduled-time: datetime, method-name: string, input: data-value);

      /// Schedule invocation for later. Call cancel on the returned resource to cancel the invocation before the scheduled time.
      schedule-cancelable-invocation: func(scheduled-time: datetime, method-name: string, input: data-value) -> cancellation-token;
    }

    /// Represents a pollable invocation result
    resource future-invoke-result {
      /// Subscribes to the result of the invocation
      subscribe: func() -> pollable;
      /// Poll for the invocation. If the invocation has not completed yet, returns `none`.
      get: func() -> option<result<data-value, rpc-error>>;
    }

    /// Cancellation token for scheduled invocations
    resource cancellation-token {
      /// Cancel the scheduled invocation
      cancel: func();
    }
}
