package golem:agent;

interface common {
  use golem:rpc/types@0.2.2.{value-and-type, wit-type, wit-value, agent-id, account-id, component-id};
  use wasi:clocks/monotonic-clock@0.2.3.{duration};

  type url = string;

  enum agent-mode {
    durable,
    ephemeral
  }

  record agent-type {
    type-name:    string,
    description:  string,
    %constructor: agent-constructor,
    methods:      list<agent-method>,
    dependencies: list<agent-dependency>,
    mode:         agent-mode,
    http-mount:   option<http-mount-details>,
    snapshotting: snapshotting,
    config:       list<config-key-value-type>,
  }

  /// Associates an agent type with a component that implements it
  record registered-agent-type {
    agent-type: agent-type,
    implemented-by: component-id
  }

  record agent-dependency {
    type-name:    string,
    description:  option<string>,
    %constructor: agent-constructor,
    methods:      list<agent-method>,
  }

  record agent-method {
    name:          string,
    description:   string,
    http-endpoint: list<http-endpoint-details>,
    prompt-hint:   option<string>,
    input-schema:  data-schema,
    output-schema: data-schema,
  }

  record http-mount-details {
    path-prefix:    list<path-segment>,
    auth-details:   option<auth-details>,
    phantom-agent:  bool,
    cors-options:   cors-options,
    webhook-suffix: list<path-segment>,
  }

  record cors-options {
    allowed-patterns: list<string>,
  }

  record http-endpoint-details {
    http-method: http-method,
    path-suffix:  list<path-segment>,
    header-vars:  list<header-variable>,
    query-vars:   list<query-variable>,
    auth-details: option<auth-details>,
    cors-options: cors-options,
  }

  variant http-method {
    get,
    head,
    post,
    put,
    delete,
    connect,
    options,
    trace,
    patch,
    custom(string),
  }

  variant path-segment {
    literal(string),
    system-variable(system-variable),
    path-variable(path-variable),
    // only allowed as the last segment
    remaining-path-variable(path-variable)
  }

  enum system-variable {
    agent-type,
    agent-version
  }

  record path-variable {
    variable-name: string,
  }

  record header-variable {
    header-name: string,
    variable-name: string,
  }

  record query-variable {
    query-param-name: string,
    variable-name: string,
  }

  record auth-details {
    required: bool,
  }

  variant principal {
    oidc(oidc-principal),
    agent(agent-principal),
    golem-user(golem-user-principal),
    anonymous
  }

  record oidc-principal {
    sub:      string,
    issuer: string,

    email:    option<string>,
    name:     option<string>,
    email-verified: option<bool>,
    given-name:     option<string>,
    family-name:    option<string>,
    picture:        option<string>,
    preferred-username:       option<string>,

    claims: string,
  }

  record agent-principal {
    agent-id: agent-id,
  }

  record golem-user-principal {
    account-id: account-id
  }

  record agent-constructor {
    name:          option<string>,
    description:   string,
    prompt-hint:   option<string>,
    input-schema:  data-schema,
  }

  variant data-schema {
    /// List of named elements
    %tuple(list<tuple<string, element-schema>>),
    /// List of named variants that can be used 0 or more times in a multimodal `data-value`
    multimodal(list<tuple<string, element-schema>>),
  }

  variant data-value {
    /// List of element values, each corresponding to an element of the tuple `data-schema`
    %tuple(list<element-value>),
    /// List of element values and their schema names; each name points to one named element of the corresponding
    /// multimodal `data-schema`.
    multimodal(list<tuple<string, element-value>>),
  }

  variant element-schema {
    component-model(wit-type),
    unstructured-text(text-descriptor),
    unstructured-binary(binary-descriptor),
  }

  variant element-value {
    component-model(wit-value),
    unstructured-text(text-reference),
    unstructured-binary(binary-reference),
  }

  record text-type {
    language-code: string,
  }

  variant text-reference {
    url(string),
    inline(text-source),
  }

  record text-source {
    data:      string,
    text-type: option<text-type>,
  }

  record text-descriptor {
    restrictions: option<list<text-type>>,
  }

  record binary-descriptor {
    restrictions: option<list<binary-type>>,
  }

  record binary-type {
    mime-type: string,
  }

  variant binary-reference {
    url(url),
    inline(binary-source),
  }

  record binary-source {
    data:        list<u8>,
    binary-type: binary-type,
  }

  variant agent-error {
    invalid-input(string),
    invalid-method(string),
    invalid-type(string),
    invalid-agent-id(string),
    custom-error(value-and-type),
  }

  variant snapshotting {
    disabled,
    enabled(snapshotting-config)
  }

  variant snapshotting-config {
    default, // current default in the server
    periodic(duration),
    every-n-invocation(u16)
  }

  record config-key-value-type {
    key:   list<string>,
    value: config-value-type,
  }

  variant config-value-type {
    local(wit-type),
    shared(wit-type),
  }
}
