syntax = "proto3";

import "golem/common/empty.proto";
import "wasm/rpc/type.proto";
import "wasm/rpc/value_and_type.proto";
import "golem/common/account_id.proto";
import "golem/component/component_id.proto";
import "golem/worker/worker_id.proto";

package golem.component;

enum AgentMode {
  DURABLE = 0;
  EPHEMERAL = 1;
}

message AgentConstructor {
  optional string name = 1;
  string description = 2;
  optional string prompt_hint = 3;
  DataSchema input_schema = 4;
}

message AgentDependency {
  string type_name = 1;
  optional string description = 2;
  AgentConstructor constructor = 3;
  repeated AgentMethod methods = 4;
}

message AgentMethod {
  string name = 1;
  string description = 2;
  optional string prompt_hint = 3;
  DataSchema input_schema = 4;
  DataSchema output_schema = 5;
  repeated HttpEndpointDetails http_endpoint = 6;
}

message AgentType {
  string type_name = 1;
  string description = 2;
  AgentConstructor constructor = 3;
  repeated AgentMethod methods = 4;
  repeated AgentDependency dependencies = 5;
  AgentMode mode = 6;
  optional HttpMountDetails http_mount = 7;
  optional Snapshotting snapshotting = 8;
}

message BinaryDescriptor {
  repeated BinaryType restrictions = 1;
}

message BinaryType {
  string mime_type = 1;
}

message NamedElementSchema {
  string name = 1;
  ElementSchema schema = 2;
}

message TupleSchema {
  repeated NamedElementSchema elements = 1;
}

message MultimodalSchema {
  repeated NamedElementSchema elements = 1;
}

message DataSchema {
  oneof schema {
    TupleSchema tuple = 1;
    MultimodalSchema multimodal = 2;
  }
}

message ElementSchema {
  oneof schema {
    wasm.rpc.Type component_model = 2;
    TextDescriptor unstructured_text = 3;
    BinaryDescriptor unstructured_binary = 4;
  }
}

message TextDescriptor {
  repeated TextType restrictions = 1;
}

message TextType {
  string language_code = 1;
}

message DataValue {
  oneof value {
    TupleValue tuple = 1;
    MultimodalValue multimodal = 2;
  }
}

message TupleValue {
  repeated ElementValue elements = 1;
}

message MultimodalValue {
  repeated NamedElementValue elements = 1;
}

message NamedElementValue {
  string name = 1;
  ElementValue value = 2;
}

message ElementValue {
  oneof value {
    wasm.rpc.ValueAndType component_model = 1;
    TextReference unstructured_text = 2;
    BinaryReference unstructured_binary = 3;
  }
}

message TextReference {
  oneof text {
    string url = 1;
    TextSource inline = 2;
  }
}

message TextSource {
  string data = 1;
  optional TextType text_type = 2;
}

message BinaryReference {
  oneof binary {
    string url = 1;
    BinarySource inline = 2;
  }
}

message BinarySource {
  bytes data = 1;
  optional BinaryType binary_type = 2;
}

message HttpMountDetails {
  repeated PathSegment path_prefix = 1;
  optional AgentHttpAuthDetails auth_details = 2;
  bool phantom_agent = 3;
  CorsOptions cors_options = 4;
  repeated PathSegment webhook_suffix = 5;
}

message HttpEndpointDetails {
  HttpMethod http_method = 1;
  repeated PathSegment path_suffix = 2;
  repeated HeaderVariable header_vars = 3;
  repeated QueryVariable query_vars = 4;
  optional AgentHttpAuthDetails auth_details = 5;
  CorsOptions cors_options = 6;
}

enum StandardHttpMethod {
  STANDARD_HTTP_METHOD_UNSPECIFIED = 0;
  STANDARD_HTTP_METHOD_GET = 1;
  STANDARD_HTTP_METHOD_HEAD = 2;
  STANDARD_HTTP_METHOD_POST = 3;
  STANDARD_HTTP_METHOD_PUT = 4;
  STANDARD_HTTP_METHOD_DELETE = 5;
  STANDARD_HTTP_METHOD_CONNECT = 6;
  STANDARD_HTTP_METHOD_OPTIONS = 7;
  STANDARD_HTTP_METHOD_TRACE = 8;
  STANDARD_HTTP_METHOD_PATCH = 9;
}

message HttpMethod {
  oneof value {
    StandardHttpMethod standard = 1;
    string custom = 2;
  }
}

message CorsOptions {
  repeated string allowed_patterns = 1;
}

message PathSegment {
  oneof value {
    LiteralSegment literal = 1;
    SystemVariableSegment system_variable = 2;
    PathVariable path_variable = 3;
    PathVariable remaining_path_variable = 4;
  }
}

message LiteralSegment {
  string value = 1;
}

message SystemVariableSegment {
  SystemVariable value = 1;
}

enum SystemVariable {
  SYSTEM_VARIABLE_UNSPECIFIED = 0;
  SYSTEM_VARIABLE_AGENT_TYPE = 1;
  SYSTEM_VARIABLE_AGENT_VERSION = 2;
}

message PathVariable {
  string variable_name = 1;
}

message HeaderVariable {
  string header_name = 1;
  string variable_name = 2;
}

message QueryVariable {
  string query_param_name = 1;
  string variable_name = 2;
}

message Snapshotting {
  oneof value {
    golem.common.Empty disabled = 1;
    SnapshottingConfig enabled = 2;
  }
}

message SnapshottingConfig {
  oneof value {
    golem.common.Empty default = 1;
    uint64 periodic_nanos = 2;
    uint32 every_n_invocation = 3;
  }
}

message AgentHttpAuthDetails {
  bool required = 1;
}

message Principal {
  oneof value {
    OidcPrincipal oidc = 1;
    AgentPrincipal agent = 2;
    GolemUserPrincipal golem_user = 3;
    golem.common.Empty anonymous = 4;
  }
}

message OidcPrincipal {
  string sub = 1;
  string issuer = 2;

  optional string email = 3;
  optional string name = 4;
  optional bool email_verified = 5;

  optional string given_name = 6;
  optional string family_name = 7;
  optional string picture = 8;
  optional string preferred_username = 9;

  string claims = 10;
}

message AgentPrincipal {
  golem.worker.WorkerId agent_id = 1;
}

message GolemUserPrincipal {
  golem.common.AccountId account_id = 1;
}
