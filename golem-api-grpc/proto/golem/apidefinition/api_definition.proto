syntax = "proto3";

package golem.apidefinition;

import "golem/rib/expr.proto";
import "golem/rib/rib_input.proto";
import "golem/rib/rib_output.proto";
import "golem/rib/rib_byte_code.proto";
import "golem/rib/worker_functions_in_rib.proto";
import "golem/component/component_id.proto";
import "golem/common/security_scheme.proto";
import "golem/common/empty.proto";
import "golem/common/account_id.proto";
import "golem/common/environment.proto";
import "google/protobuf/timestamp.proto";

message CompiledRoutes {
  golem.common.AccountId account_id = 1;
  golem.common.EnvironmentId environment_id = 2;
  repeated SecuritySchemeDetails security_schemes = 3;
  repeated CompiledHttpRoute compiled_routes = 4;
}

message CompiledHttpRoute {
   HttpMethod method = 1;
   string path = 2;
   CompiledGatewayBinding binding = 3;
   golem.common.SecuritySchemeId security_scheme_id = 4;
}

enum HttpMethod {
  HTTP_METHOD_UNSPECIFIED = 0;
  HTTP_METHOD_GET = 1;
  HTTP_METHOD_CONNECT = 2;
  HTTP_METHOD_POST = 3;
  HTTP_METHOD_DELETE = 4;
  HTTP_METHOD_PUT = 5;
  HTTP_METHOD_PATCH = 6;
  HTTP_METHOD_OPTIONS = 7;
  HTTP_METHOD_TRACE = 8;
  HTTP_METHOD_HEAD = 9;
}

message CompiledGatewayBinding {
  oneof binding {
    CompiledWorkerBinding worker_binding = 1;
    CompiledHttpHandlerBinding http_handler_binding = 2;
    CompiledFileServerBinding file_server_binding = 3;
    CompiledHttpCorsBinding http_cors_binding = 4;
    golem.common.Empty swagger_ui_binding = 5;
  }
}

message WorkerNameCompiled {
  golem.rib.Expr expr = 1;
  golem.rib.RibByteCode compiled_expr = 2;
  golem.rib.RibInputType rib_input = 3;
}

message IdempotencyKeyCompiled {
  golem.rib.Expr expr = 1;
  golem.rib.RibByteCode compiled_expr = 2;
  golem.rib.RibInputType rib_input = 3;
}

message InvocationContextCompiled {
  golem.rib.Expr expr = 1;
  golem.rib.RibByteCode compiled_expr = 2;
  golem.rib.RibInputType rib_input = 3;
}

message ResponseMappingCompiled {
  golem.rib.Expr expr = 1;
  golem.rib.RibByteCode compiled_expr = 2;
  golem.rib.RibInputType rib_input = 3;
  optional golem.rib.WorkerFunctionsInRib worker_functions = 4;
  optional golem.rib.RibOutputType rib_output = 5;
}

message CompiledWorkerBinding {
  golem.component.ComponentId component_id = 1;
  uint64 component_revision = 2;
  string component_name = 3;
  optional IdempotencyKeyCompiled idempotency_key = 4;
  optional InvocationContextCompiled invocation_context = 5;
  ResponseMappingCompiled response_mapping = 6;
}

message CompiledHttpHandlerBinding {
  golem.component.ComponentId component_id = 1;
  uint64 component_revision = 2;
  string component_name = 3;
  WorkerNameCompiled worker_name_compiled = 4;
  optional IdempotencyKeyCompiled idempotency_key_compiled = 5;
  optional InvocationContextCompiled invocation_context_compiled = 6;
}

message CompiledFileServerBinding {
  golem.component.ComponentId component_id = 1;
  uint64 component_revision = 2;
  string component_name = 3;
  WorkerNameCompiled worker_name_compiled = 4;
  ResponseMappingCompiled response_compiled = 5;
}

message CompiledHttpCorsBinding {
  HttpCors http_cors = 1;
}

// message CompiledGatewayBinding {
//     optional golem.component.ComponentId component_id = 1;
//     optional uint64 component_revision = 2;
//     optional golem.rib.Expr worker_name = 3;
//     optional golem.rib.RibByteCode compiled_worker_name_expr = 4;
//     optional golem.rib.RibInputType worker_name_rib_input = 5;
//     optional golem.rib.Expr response = 6;
//     optional golem.rib.RibByteCode compiled_response_expr = 7;
//     optional golem.rib.RibInputType response_rib_input = 8;
//     optional golem.rib.Expr idempotency_key = 9;
//     optional golem.rib.RibByteCode compiled_idempotency_key_expr = 10;
//     optional golem.rib.RibInputType idempotency_key_rib_input = 11;
//     optional golem.rib.WorkerFunctionsInRib worker_functions_in_response = 12;
//     // type discriminator to keep backward compatibility
//     optional GatewayBindingType binding_type = 13;
//     optional StaticBinding static_binding = 14;
//     optional golem.rib.RibOutputType response_rib_output = 15;
//     optional golem.rib.Expr invocation_context = 16;
//     optional golem.rib.RibByteCode compiled_invocation_context_expr = 17;
//     optional golem.rib.RibInputType invocation_context_rib_input = 18;
//     optional string openapi_spec_json = 19;
// }

message HttpCors {
  optional string allow_origin = 1;
  optional string allow_methods = 2;
  optional string allow_headers = 3;
  optional string expose_headers = 4;
  optional uint64 max_age = 5;
  optional bool allow_credentials = 6;
}

message SecuritySchemeDetails {
  golem.common.SecuritySchemeId id = 1;
  Provider provider = 2;
  string client_id = 3;
  string client_secret = 4;
  string redirect_url = 5;
  repeated string scopes = 6;
}

enum Provider {
  PROVIDER_UNSPECIFIED = 0;
  PROVIDER_GOOGLE = 1;
  PROVIDER_FACEBOOK = 2;
  PROVIDER_MICROSOFT = 3;
  PROVIDER_GITLAB = 4;
}
