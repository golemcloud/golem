syntax = "proto3";

package golem.worker;

import "golem/common/account_id.proto";
import "golem/common/empty.proto";
import "golem/common/environment.proto";
import "golem/common/uuid.proto";
import "golem/component/agent.proto";
import "golem/worker/idempotency_key.proto";
import "golem/worker/invocation_context.proto";
import "golem/worker/worker_id.proto";
import "google/protobuf/timestamp.proto";
import "wasm/rpc/value_and_type.proto";
import "golem/worker/wasi_config_vars.proto";

message OplogEntry {
  oneof entry {
    CreateParameters Create = 1;
    HostCallParameters HostCall = 2;
    AgentInvocationStartedParameters AgentInvocationStarted = 3;
    AgentInvocationFinishedParameters AgentInvocationFinished = 4;
    TimestampParameter Suspend = 5;
    ErrorParameters Error = 6;
    TimestampParameter NoOp = 7;
    JumpParameters Jump = 8;
    TimestampParameter Interrupted = 9;
    TimestampParameter Exited = 10;
    ChangeRetryPolicyParameters ChangeRetryPolicy = 11;
    TimestampParameter BeginAtomicRegion = 12;
    EndAtomicRegionParameters EndAtomicRegion = 13;
    TimestampParameter BeginRemoteWrite = 14;
    EndRemoteWriteParameters EndRemoteWrite = 15;
    PendingAgentInvocationParameters PendingAgentInvocation = 16;
    PendingUpdateParameters PendingUpdate = 17;
    SuccessfulUpdateParameters SuccessfulUpdate = 18;
    FailedUpdateParameters FailedUpdate = 19;
    GrowMemoryParameters GrowMemory = 20;
    CreateResourceParameters CreateResource = 21;
    DropResourceParameters DropResource = 22;
    LogParameters Log = 24;
    TimestampParameter Restart = 25;
    ActivatePluginParameters ActivatePlugin = 26;
    DeactivatePluginParameters DeactivatePlugin = 27;
    RevertParameters Revert = 28;
    CancelInvocationParameters CancelInvocation = 29;
    StartSpanParameters StartSpan = 30;
    FinishSpanParameters FinishSpan = 31;
    SetSpanAttributeParameters SetSpanAttribute = 32;
    ChangePersistenceLevelParameters ChangePersistenceLevel = 33;
    BeginRemoteTransactionParameters BeginRemoteTransaction = 34;
    RemoteTransactionParameters PreCommitRemoteTransaction = 35;
    RemoteTransactionParameters PreRollbackRemoteTransaction = 36;
    RemoteTransactionParameters CommittedRemoteTransaction = 37;
    RemoteTransactionParameters RolledBackRemoteTransaction = 38;
    SnapshotDataParameters Snapshot = 39;
  }
}

message WrappedFunctionType {
  enum Type {
    READ_LOCAL = 0;
    WRITE_LOCAL = 1;
    READ_REMOTE = 2;
    WRITE_REMOTE = 3;
    WRITE_REMOTE_BATCHED = 4;
    WRITE_REMOTE_TRANSACTION = 5;
  }
  Type type = 1;
  optional uint64 oplog_index = 2;
}

message PluginInstallationDescription {
  int32 plugin_priority = 1;
  string plugin_name = 2;
  string plugin_version = 3;
  map<string, string> parameters = 4;
  bool registered = 5;
}

message CreateParameters {
  google.protobuf.Timestamp timestamp = 1;
  WorkerId worker_id = 2;
  uint64 component_revision = 3;
  map<string, string> env = 5;
  golem.common.AccountId created_by = 6;
  optional WorkerId parent = 7;
  uint64 component_size = 8;
  uint64 initial_total_linear_memory_size = 9;
  repeated PluginInstallationDescription initial_active_plugins = 10;
  golem.common.EnvironmentId environment_id = 11;
  WasiConfigVars wasi_config_vars = 12;
  optional golem.common.UUID original_phantom_id = 13;
}

message HostCallParameters {
  google.protobuf.Timestamp timestamp = 1;
  string function_name = 2;
  wasm.rpc.ValueAndType request = 3;
  wasm.rpc.ValueAndType response = 4;
  WrappedFunctionType wrapped_function_type = 5;
}

message AgentInvocationStartedParameters {
  google.protobuf.Timestamp timestamp = 1;
  PublicAgentInvocation invocation = 2;
}

message AgentInvocationFinishedParameters {
  google.protobuf.Timestamp timestamp = 1;
  PublicAgentInvocationResult result = 2;
  int64 consumed_fuel = 3;
}

message PublicAgentInvocation {
  oneof invocation {
    PublicAgentInitializationInvocation agent_initialization = 1;
    PublicAgentMethodInvocation agent_method = 2;
    golem.common.Empty save_snapshot = 3;
    LoadSnapshotInvocationParameters load_snapshot = 4;
    ProcessOplogEntriesInvocationParameters process_oplog_entries = 5;
    ManualUpdateInvocationParameters manual_update = 6;
  }
}

message PublicAgentInitializationInvocation {
  golem.worker.IdempotencyKey idempotency_key = 1;
  golem.component.TypedDataValue constructor_parameters = 2;
  string trace_id = 3;
  repeated string trace_states = 4;
  repeated golem.worker.InvocationSpan invocation_context = 5;
}

message PublicAgentMethodInvocation {
  golem.worker.IdempotencyKey idempotency_key = 1;
  string method_name = 2;
  golem.component.TypedDataValue function_input = 3;
  string trace_id = 4;
  repeated string trace_states = 5;
  repeated golem.worker.InvocationSpan invocation_context = 6;
}

message LoadSnapshotInvocationParameters {
  SnapshotData snapshot = 1;
}

message ProcessOplogEntriesInvocationParameters {
  golem.worker.IdempotencyKey idempotency_key = 1;
}

message ManualUpdateInvocationParameters {
  uint64 target_revision = 1;
}

message PublicAgentInvocationResult {
  oneof result {
    golem.component.TypedDataValue agent_initialization_output = 1;
    golem.component.TypedDataValue agent_method_output = 2;
    golem.common.Empty manual_update = 3;
    OptionalError load_snapshot = 4;
    SnapshotData save_snapshot = 5;
    OptionalError process_oplog_entries = 6;
  }
}

message OptionalError {
  optional string error = 1;
}

message SnapshotData {
  oneof data {
    RawSnapshotData raw = 1;
    JsonSnapshotData json = 2;
  }
}

message ErrorParameters {
  google.protobuf.Timestamp timestamp = 1;
  string error = 2;
  uint64 retry_from = 3;
}

message JumpParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 start = 2;
  uint64 end = 3;
}

message ChangeRetryPolicyParameters {
  google.protobuf.Timestamp timestamp = 1;
  RetryPolicy retry_policy = 2;
}

message RetryPolicy {
  uint32 max_attempts = 1;
  uint64 min_delay = 2;
  uint64 max_delay = 3;
  double multiplier = 4;
  optional double max_jitter_factor = 5;
}

message EndAtomicRegionParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 begin_index = 2;
}

message EndRemoteWriteParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 begin_index = 2;
}

message BeginRemoteTransactionParameters {
  google.protobuf.Timestamp timestamp = 1;
  string transaction_id = 2;
}

message RemoteTransactionParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 begin_index = 2;
}

message PendingAgentInvocationParameters {
  google.protobuf.Timestamp timestamp = 1;
  PublicAgentInvocation invocation = 2;
}

message SnapshotBasedUpdateParameters {
  bytes payload = 1;
  string mime_type = 2;
}

message UpdateDescription {
  oneof description {
    golem.common.Empty auto_update = 1;
    SnapshotBasedUpdateParameters snapshot_based = 2;
  }
}

message PendingUpdateParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 target_revision = 2;
  UpdateDescription update_description = 3;
}

message SuccessfulUpdateParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 target_revision = 2;
  uint64 new_component_size = 3;
  repeated PluginInstallationDescription new_active_plugins = 10;
}

message FailedUpdateParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 target_revision = 2;
  optional string details = 3;
}

message GrowMemoryParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 delta = 2;
}

message CreateResourceParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 resource_id = 2;
  string name = 3;
  string owner = 4;
}

message DropResourceParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 resource_id = 2;
  string name = 3;
  string owner = 4;
}

message TimestampParameter {
  google.protobuf.Timestamp timestamp = 1;
}

message ActivatePluginParameters {
  google.protobuf.Timestamp timestamp = 1;
  PluginInstallationDescription plugin = 2;
}

message DeactivatePluginParameters {
  google.protobuf.Timestamp timestamp = 1;
  PluginInstallationDescription plugin = 2;
}

message RevertParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 start = 2;
  uint64 end = 3;
}

message CancelInvocationParameters {
  google.protobuf.Timestamp timestamp = 1;
  IdempotencyKey idempotency_key = 2;
}

message StartSpanParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 span_id = 2;
  optional uint64 parent_id = 3;
  optional uint64 linked_context = 4;
  map<string, AttributeValue> attributes = 5;
}

message FinishSpanParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 span_id = 2;
}

message SetSpanAttributeParameters {
  google.protobuf.Timestamp timestamp = 1;
  uint64 span_id = 2;
  string key = 3;
  AttributeValue value = 4;
}

message ChangePersistenceLevelParameters {
  google.protobuf.Timestamp timestamp = 1;
  PersistenceLevel persistence_level = 2;
}

enum OplogLogLevel {
  OPLOG_STDOUT = 0;
  OPLOG_STDERR = 1;
  OPLOG_TRACE = 2;
  OPLOG_DEBUG = 3;
  OPLOG_INFO = 4;
  OPLOG_WARN = 5;
  OPLOG_ERROR = 6;
  OPLOG_CRITICAL = 7;
}

message LogParameters {
  google.protobuf.Timestamp timestamp = 1;
  OplogLogLevel level = 2;
  string context = 3;
  string message = 4;
}

message SnapshotDataParameters {
  google.protobuf.Timestamp timestamp = 1;
  oneof data {
    RawSnapshotData raw = 2;
    JsonSnapshotData json = 3;
  }
}

message RawSnapshotData {
  bytes data = 1;
  string mime_type = 2;
}

message JsonSnapshotData {
  string data = 1;
}

message OplogEntryWithIndex {
  uint64 oplog_index = 1;
  OplogEntry entry = 2;
}

enum PersistenceLevel {
  PERSIST_NOTHING = 0;
  PERSIST_REMOTE_SIDE_EFFECTS = 1;
  SMART = 2;
}
