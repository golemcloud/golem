syntax = "proto3";

package golem.worker.v1;

import "golem/common/empty.proto";
import "golem/common/revert_worker_response.proto";
import "golem/worker/complete_parameters.proto";
import "golem/worker/cursor.proto";
import "golem/worker/idempotency_key.proto";
import "golem/worker/invocation_context.proto";

import "golem/worker/v1/worker_error.proto";
import "golem/worker/worker_filter.proto";
import "golem/worker/worker_metadata.proto";
import "golem/worker/log_event.proto";
import "golem/worker/oplog_cursor.proto";
import "golem/worker/public_oplog.proto";
import "golem/worker/worker_id.proto";
import "golem/component/component_id.proto";
import "golem/worker/update_mode.proto";
import "golem/worker/filesystem.proto";
import "golem/auth/auth_ctx.proto";
import "golem/component/agent.proto";
import "golem/common/uuid.proto";
import "google/protobuf/timestamp.proto";

service WorkerService {
  rpc LaunchNewWorker (LaunchNewWorkerRequest) returns (LaunchNewWorkerResponse);
  rpc UpdateWorker(UpdateWorkerRequest) returns (UpdateWorkerResponse);
  rpc ResumeWorker (ResumeWorkerRequest) returns (ResumeWorkerResponse);
  rpc ForkWorker(ForkWorkerRequest) returns (ForkWorkerResponse);
  rpc RevertWorker(RevertWorkerRequest) returns (RevertWorkerResponse);
  rpc CompletePromise (CompletePromiseRequest) returns (CompletePromiseResponse);
  rpc InvokeAgent (InvokeAgentRequest) returns (InvokeAgentResponse);
}

message LaunchNewWorkerRequest {
  golem.component.ComponentId componentId = 1;
  string name = 2;
  map<string, string> env = 4;
  map<string, string> config_vars = 5;
  bool ignore_already_existing = 6;
  golem.auth.AuthCtx auth_ctx = 7;
  optional golem.worker.InvocationContext context = 8;
  optional golem.component.Principal principal = 9;
}

message LaunchNewWorkerResponse {
  oneof result {
    LaunchNewWorkerSuccessResponse success = 1;
    golem.worker.v1.WorkerError error = 2;
  }
}

message LaunchNewWorkerSuccessResponse {
  golem.worker.WorkerId workerId = 1;
  uint64 component_version = 2;
}

message CompletePromiseRequest {
  golem.worker.WorkerId workerId = 1;
  golem.worker.CompleteParameters completeParameters = 2;
  golem.auth.AuthCtx auth_ctx = 3;
}

message CompletePromiseResponse {
  oneof result {
    bool success = 1;
    golem.worker.v1.WorkerError error = 2;
  }
}

message ForkWorkerRequest {
  golem.worker.WorkerId source_worker_id = 1;
  golem.worker.WorkerId target_worker_id = 2;
  uint64 oplog_index_cutoff = 3;
  golem.auth.AuthCtx auth_ctx = 4;
}

message ForkWorkerResponse {
  oneof result {
    golem.common.Empty success = 1;
    golem.worker.v1.WorkerError error  = 2;
  }
}

message ResumeWorkerRequest {
  golem.worker.WorkerId workerId = 1;
  optional bool force = 2;
  golem.auth.AuthCtx auth_ctx = 3;
}

message ResumeWorkerResponse {
  oneof result {
    golem.common.Empty success = 1;
    golem.worker.v1.WorkerError error = 2;
  }
}

message UpdateWorkerRequest {
  golem.worker.WorkerId worker_id = 1;
  uint64 target_revision = 2;
  golem.worker.UpdateMode mode = 3;
  golem.auth.AuthCtx auth_ctx = 4;
  bool disable_wakeup = 5;
}

message UpdateWorkerResponse {
  oneof result {
    golem.common.Empty success = 1;
    WorkerError error = 2;
  }
}

message ListFileSystemNodeResponse {
  repeated golem.worker.FileSystemNode nodes = 1;
}

message RevertWorkerRequest {
  golem.worker.WorkerId worker_id = 1;
  golem.common.RevertWorkerTarget target = 2;
  golem.auth.AuthCtx auth_ctx = 3;
}

message RevertWorkerResponse {
  oneof result {
    golem.common.Empty success = 1;
    WorkerError error = 2;
  }
}

enum AgentInvocationMode {
  AGENT_INVOCATION_MODE_AWAIT = 0;
  AGENT_INVOCATION_MODE_SCHEDULE = 1;
}

message InvokeAgentRequest {
  golem.worker.WorkerId worker_id = 1;
  string method_name = 2;
  golem.component.UntypedDataValue method_parameters = 3;
  AgentInvocationMode mode = 4;
  optional google.protobuf.Timestamp schedule_at = 5;
  optional golem.worker.IdempotencyKey idempotency_key = 6;
  optional golem.worker.InvocationContext context = 7;
  golem.auth.AuthCtx auth_ctx = 8;
  golem.component.Principal principal = 9;
}

message InvokeAgentResponse {
  oneof result {
    InvokeAgentSuccess success = 1;
    WorkerError error = 2;
  }
}

message InvokeAgentSuccess {
  optional golem.component.UntypedDataValue result = 1;
  optional uint64 fuel_consumed = 2;
  optional uint64 component_revision = 3;
}
