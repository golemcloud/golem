name: CI
on:
#  push:
#    tags:
#      - "v*.*.*"
#    branches:
#      - main
#  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  pull-requests: write

env:
  BUILD_TARGET: "x86_64-unknown-linux-gnu"
  VCPKG_DEFAULT_TRIPLET: "x64-mingw-dynamic"
  VCPKG_ENABLE_METRICS: 0

jobs:
  build:
    env:
      CARGO_BUILD_JOBS: 10
#    runs-on: blacksmith-16vcpu-ubuntu-2204
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Fetch tag
        run: git fetch origin --deepen=1
      - name: Set up MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          static: false
          version: 14.2.0
      - name: Setup Rust
        run: |
          rustup install stable-gnu
          rustup update stable-gnu --no-self-update
          rustup set default-host x86_64-pc-windows-gnu
          rustup override set stable-x86_64-pc-windows-gnu
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: v3-rust
          shared-key: debug
          cache-all-crates: true
          save-if: true
      - uses: davidB/rust-cargo-make@v1
      - name: Setup anew (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: 'C:/vcpkg'
          runVcpkgInstall: true
      - name: Building all executables
        env:
          QUIET: true
        run: |
          $env:PROTOC="$PWD/vcpkg_installed/x64-mingw-dynamic/tools/protobuf/protoc.exe"
          $env:PROTOC_INCLUDE = "$PWD/vcpkg_installed/x64-mingw-dynamic/include"
          $env:PATH="$PWD/vcpkg_installed/x64-mingw-dynamic/bin/;" + $env:PATH
          cargo make --profile ci build
        timeout-minutes: 180

  unit-tests-and-checks:
    if: false
    env:
      CARGO_BUILD_JOBS: 10
    #    runs-on: blacksmith-16vcpu-ubuntu-2204
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Fetch tag
        run: git fetch origin --deepen=1
      - name: Set up MinGW
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
          static: false
          version: 14.2.0
      - name: Setup Rust
        run: |
          rustup install stable-gnu
          rustup update stable-gnu --no-self-update
          rustup set default-host x86_64-pc-windows-gnu
          rustup override set stable-x86_64-pc-windows-gnu
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: v3-rust
          shared-key: debug
          cache-all-crates: true
          save-if: true
      - uses: davidB/rust-cargo-make@v1
      - name: Setup anew (or from cache) vcpkg (and does not build any package)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: 'C:/vcpkg'
          runVcpkgInstall: true
      - name: Unit tests
        run: cargo make --profile ci unit-tests
      - name: Check formatting and clippy rules
        run: cargo make --profile ci check
      - name: Check openapi is up to date
        run: cargo make --profile ci check-openapi
      - name: Check configs are up to date
        run: cargo make --profile ci check-configs
      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: "**/target/report-*.xml"
          detailed_summary: true
          include_passed: true
