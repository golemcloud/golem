# Issue #1201 — gRPC and OpenAPI Integration: Plan and Checklist

Reference: https://github.com/golemcloud/golem/issues/1201

> Status: Phase 1 scaffold implemented and pushed in branch `feat/wit-generators-phase1`. Follow-up phases pending.

## Scope (from bounty)
- Inputs: Protobuf (proto3) with gRPC services; OpenAPI 3.0.x YAML/JSON
- Outputs: WIT packages/interfaces/records with idiomatic, deterministic naming
- Runtime: dynamic stubs in `worker-executor` for gRPC/HTTP with durability (record/playback, oplog)
- Tooling: `golem-cli` captures schemas, extends manifest, updates REST APIs, stores artifacts, exposes to executor
- Tests: unit, integration (CLI + generators), system E2E against real APIs
- Auth and errors: standard auth records and expressive error variant

## Deliverables by Phase

### Phase 1 — Generators (workspace crates)
- [x] Create `tools/openapi-to-wit` crate (OpenAPI→WIT)
- [x] Create `tools/protobuf-to-wit` crate (Protobuf→WIT)
- [x] Add crates to workspace and CI
- [x] Define deterministic naming and collision resolution spec (kebab-case, reserved `%`, suffixing)
- [x] Implement core mappings:
  - [x] Protobuf: message→record, service→interface, preserve field order (basic scalars)
  - [x] OpenAPI: components.schemas→records, paths→interface, request/response `$ref` mapping; arrays → `list<T>`; component string `enum` → WIT `variant`
- [x] Golden tests using Todo examples (OpenAPI and gRPC)
- Notes (Phase 1 scope limits): component enums and arrays covered; inline schema lifting is partial; complex formats (number formats, objects-of-objects), parameters/header mapping, multi-interface grouping still pending; single interface per doc/service; placeholder error variants

### Phase 2 — CLI capture and preview
- [ ] Extend `golem.yaml` to support deps of type `grpc` and `openapi`
- [ ] CLI: commands to add deps and fetch/store canonical schema artifacts
- [ ] CLI: `generate-wit preview` integrating both generator crates
- [ ] Update component create/update REST APIs to accept new deps and schema metadata
- [ ] Storage format finalized for executor use

### Phase 3 — Worker executor dynamic stubs
- [ ] Executor loads structured schema metadata at worker launch
- [ ] Link-time dynamic stub synthesis for:
  - [ ] gRPC stubs (using Rust gRPC client)
  - [ ] HTTP/OpenAPI stubs (using HTTP client)
- [ ] Header/auth handling:
  - [ ] Authorization→auth field
  - [ ] ETag→version; If-Match→expected-version; Last-Modified→last-updated
  - [ ] Other headers→optional kebab-case fields
- [ ] Durability
  - [ ] Branch record/playback mode
  - [ ] Persist request/response in oplog per call
  - [ ] Retry/backoff strategy where applicable

### Phase 4 — Error and auth model
- [ ] Error variant at least as expressive as: unauthorized, not-found, validation-error, rate-limited { retry-after }, server-error
- [ ] Auth records: bearer, basic, api-key
- [ ] Map OpenAPI and gRPC errors/auth into the model consistently

### Phase 5 — Tests
- Unit tests
  - [x] Name resolver and basic type mappings for both generators
  - [ ] Header/auth transforms and special header mapping
- Integration tests
  - [ ] CLI + generators cohesion (add dep → generate WIT preview)
  - [ ] Manifest parser updates and REST API wiring (mocked)
- System/E2E tests
  - [ ] OpenAPI (at least the following):
    - [ ] Cloudflare: https://github.com/cloudflare/api-schemas
    - [ ] OpenAI: https://github.com/openai/openai-openapi
    - [ ] GitHub: https://github.com/github/rest-api-description
  - [ ] gRPC (at least the following):
    - [ ] https://grpcb.in/
    - [ ] https://cloud.google.com/text-to-speech/docs/reference/rpc
  - [ ] Verify generated WIT correctness and real invocation via dynamic stubs
  - [ ] Durability tests (record/playback) for failures and retries

### Phase 6 — Docs and examples
- [ ] Developer docs for adding deps and generating WIT
- [ ] Example app referencing both OpenAPI and gRPC deps
- [ ] Executor integration guide and durability behavior

## Design specifics

### WIT package and version
- gRPC: package name from proto package; version from configuration input
- OpenAPI: package name from sanitized `info.title`; version from `info.version`

### Naming and IDs (deterministic)
- kebab-case for all generated identifiers
- Reserved words prefixed with `%`
- Suffixing for collisions: `_record`, `_params`, `_result`, then fail with guidance
- ≤64 characters; stable synthesis for inline schemas:
  - Request bodies: `{path}-{method}-request-body`
  - Response bodies: `{path}-{method}-response-body`
  - Array items: `{parent-type}-item`
  - Nested objects: `{parent-type}-{field-name}`
  - Parameters: `{path}-{method}-params`

### API surface
- gRPC: service→interface, RPC→function returning `result<response, error>`
- OpenAPI: resource grouping (collection/resource interfaces), path/query params into request types
- Headers:
  - Authorization→auth
  - ETag→version
  - If-Match→expected-version
  - Last-Modified→last-updated
  - Others→optional kebab-case fields

## Risks and mitigations
- OpenAPI complexity (polymorphism, discriminators): start with core schemas; clear diagnostics for unsupported features; incremental coverage
- Streaming gRPC: explicitly define v1 scope (no streaming) or map to async streams if required; document
- Collisions: rigorous detection with fast-fail and remediation suggestions
- Version skew: pin OpenAPI/Protobuf tool versions; snapshot tests

## Acceptance alignment
- Strongly typed, modular code; minimal duplication; consistent with existing conventions
- CI green and kept in sync with head branch
- E2E verification against real APIs + durability
- Sufficient docs for developers and end users

## Initial tasks (to start now)
- [x] Scaffold `tools/openapi-to-wit` and `tools/protobuf-to-wit` crates
- [x] Add to workspace and CI
- [x] Implement name/collision resolver module with tests
- [x] Add golden tests using the Todo OpenAPI and gRPC examples from `schema.golem.cloud/app/details.md`
- [ ] CLI spike: `golem-cli generate-wit --from openapi|grpc --input <path-or-url>` (preview only)

---
- Organization reference: https://github.com/golemcloud
